// Adobe Corp. project "webpage-blueprint-detector" - Author: catalan@adobe.com
(()=>{var N=(o,e,n)=>{if(!e.has(o))throw TypeError("Cannot "+n)};var y=(o,e,n)=>(N(o,e,"read from private field"),n?n.call(o):e.get(o)),M=(o,e,n)=>{if(e.has(o))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(o):e.set(o,n)},w=(o,e,n,t)=>(N(o,e,"write to private field"),t?t.call(o,n):e.set(o,n),n);function E(o){return o.toString(16)}function D(o,e,n,t){return E(o)+E(e)+E(n)+E(t)}var g=class o{constructor({r:e,g:n,b:t,a:i=1,name:s=""}){this.name=s,this.r=e,this.g=n,this.b=t,this.a=i}toHex(){return D(this.r,this.g,this.b,this.a)}static fromRGBA(e){let n=e.replace("rgba(","").replace(")","").split(",").map(t=>parseInt(t.trim()));return new o({r:n[0],g:n[1],b:n[2],a:n[3]})}toRGBA(){return`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a})`}withAlpha(e){return new o({...this,a:e})}static random(e=!1){let n=Math.round(Math.random()*255),t=Math.round(Math.random()*255),i=Math.round(Math.random()*255),s=e?Math.random():1;return new o({name:`rand-${n}-${t}-${i}-${s}`,r:n,g:t,b:i,a:s})}static fromHex(e){let n=parseInt(e.substring(0,2),16),t=parseInt(e.substring(2,4),16),i=parseInt(e.substring(4,6),16),s=parseInt(e.substring(6,8),16);return new o({name:`hex-${n}-${t}-${i}-${s}`,r:n,g:t,b:i,a:s})}};function P(o,e){let n=Math.max(0,Math.min(o.x+o.width,e.x+e.width)-Math.max(o.x,e.x)),t=Math.max(0,Math.min(o.y+o.height,e.y+e.height)-Math.max(o.y,e.y)),i=n*t,s=e.width*e.height;return i/s*100}function $(o){let e=o.getBoundingClientRect();return{left:e.left+window.document.scrollingElement.scrollLeft,top:e.top+window.document.scrollingElement.scrollTop}}var m=class o{constructor(e,n,t,i,s){this.id=crypto.randomUUID(),this.x=Math.round(e),this.y=Math.round(n),this.width=Math.round(t),this.height=Math.round(i),this.div=s,this.children=[],this.prediction=null,this.layout=null}static fromDiv(e){let n=e.getBoundingClientRect(),t=$(e);return new o(t.left,t.top,n.width,n.height,e)}static areBoxesLaidOutAsGrid(e){console.log("areBoxesLaidOutAsGrid");try{if(e.length<2)return!1;let n=e.slice().sort((a,d)=>a.x-d.x||a.y-d.y),t=e.slice().sort((a,d)=>a.y-d.y||a.x-d.x);console.log(n),console.log(t);let i=[];for(let a=1;a<n.length;a++)i.push(n[a].x-n[a-1].x);if([...new Set(i)].length>1)return!1;let r=[];for(let a=1;a<t.length;a++)r.push(t[a].y-t[a-1].y);return!([...new Set(r)].length>1)}finally{return!0}}contains(e,n=!0){return n?e.x-e.width>=this.x-this.width&&e.x+e.width<=this.x+this.width&&e.y-e.height>=this.y-this.height&&e.y+e.height<=this.y+this.height:P(this,e)>75}intersects(e){return!(e.x-e.width>this.x+this.width||e.x+e.width<this.x-this.width||e.y-e.height>this.y+this.height||e.y+e.height<this.y-this.height)}isInside(e){return e.x-e.width<=this.x-this.width&&e.x+e.width>=this.x+this.width&&e.y-e.height<=this.y-this.height&&e.y+e.height>=this.y+this.height}addChild(e){this.children.push(e)}isChild(e){return this.children.some(this.isChild)}determineLayout(){let e=this.children.sort((r,l)=>r.y<l.y?-1:r.y>l.y?1:r.x-l.x),n=1,t=1,i=e[0],s=1;for(let r=1;r<e.length;r+=1){let l=e[r];l.y+5>=i.y+i.height&&(n+=1,t=Math.max(t,s),s=1),l.x+5>=i.x+i.width&&(s+=1),i=l}return t=Math.max(t,s),this.layout={numRows:n,numCols:t},this.layout}};var u=class o{static getXPath(e,n=!1){for(var t=document.getElementsByTagName("*"),i=[];e&&e.nodeType==1;e=e.parentNode)if(n)if(e.hasAttribute("id")){for(var s=0,r=0;r<t.length&&(t[r].hasAttribute("id")&&t[r].id==e.id&&s++,!(s>1));r++);if(s==1)return i.unshift('id("'+e.getAttribute("id")+'")'),i.join("/");i.unshift(e.localName.toLowerCase()+'[@id="'+e.getAttribute("id")+'"]')}else e.hasAttribute("class")&&i.unshift(e.localName.toLowerCase()+'[@class="'+[...e.classList].join(" ").trim()+'"]');else{for(var l=1,a=e.previousSibling;a;a=a.previousSibling)a.localName==e.localName&&(l+=1);i.unshift(e.localName.toLowerCase()+"["+l+"]")}return i.length?"/"+i.join("/"):null}static isVisible(e){if(!e)return!1;if(e.nodeType===Node.DOCUMENT_NODE)return!0;if(e.nodeType===Node.ELEMENT_NODE){let n=window.getComputedStyle(e);return n.display.includes("none")||n.visibility.includes("hidden")||n.opacity==="0"?!1:o.isVisible(e.parentNode)}return o.isVisible(e.parentNode)}static getNSiblingsElements(e,n){let t=n;isNaN(n)||(t=r=>r===n);let i="",s=[];e.querySelectorAll("div").forEach(r=>{let l=o.getXPath(r),a=l.substring(0,l.lastIndexOf("["));s[a]?s[a].push(r):s[a]=[r]});for(let r in s)if(t(s[r].length)){i=r;break}return s[i]}static getPageSize(){var e=document.documentElement,n=document.body,t=Math.max(e.clientWidth,e.scrollWidth,e.offsetWidth,n.scrollWidth,n.offsetWidth),i=Math.max(e.clientHeight,e.scrollHeight,e.offsetHeight,n.scrollHeight,n.offsetHeight);return{width:t,height:i}}static getOffsetRect(e){let n=e.getBoundingClientRect();return{x:n.left+window.document.scrollingElement.scrollLeft,y:n.top+window.document.scrollingElement.scrollTop,width:n.width,height:n.height}}static checkElStackUpCSSClasses(e,n,t="up"){if(t==="up"){let i=e;for(;i;){if(i.classList.contains(n))return!0;i=i.parentElement}return!1}return!1}};var v=class{constructor(...e){e.reduce((n,t,i)=>(n[t]=1<<i,n),this)}},p,b=class{constructor(...e){M(this,p,0);w(this,p,0),this.setFlags(...e)}get flag(){return y(this,p)}setFlags(...e){w(this,p,e.reduce((n,t)=>n|t,0))}setFlag(e){w(this,p,y(this,p)|e)}unsetFlag(e){w(this,p,y(this,p)&~e)}isFlagSet(e){return(y(this,p)&e)!==0}areOnlyFlagsSet(...e){let n=e.reduce((t,i)=>t|i,0);return y(this,p)===n}getFlags(e){return Object.keys(e).filter(n=>this.isFlagSet(e[n]))}};p=new WeakMap;function F(o){var e=0,n=o.length,t=0;if(n>0)for(;t<n;)e=(e<<5)-e+o.charCodeAt(t++)|0;return e}function k(o){return o?o.replaceAll(`
`," ").replaceAll("	"," ").replaceAll(/\s+/g," ").trim():""}function O(o,...e){return(...n)=>{let t=n[n.length-1]||{},i=[o[0]];return e.forEach((s,r)=>{let l=Number.isInteger(s)?n[s]:t[s];i.push(l,o[r+1])}),i.join("")}}async function G(o){return new Promise(e=>{let n=0,t=500,i=setInterval(()=>{let{scrollHeight:s}=window.document.scrollingElement;n+=t,window.document.scrollingElement.scrollTo({top:n,left:0,behavior:"instant"}),n>=s&&(clearInterval(i),e(!0))},100)})}async function L(o,e={postReset:!0}){try{await G(o),await setTimeout(()=>{},250),e.postReset&&(window.document.scrollingElement.scrollTo({left:0,top:0,behavior:"instant"}),await setTimeout(()=>{},250))}catch(n){throw new Error(`smart scroll failed: ${n}`)}}function R(o){let e=o.div,n=null,t=null;return n=[...e.querySelectorAll("*")].some(i=>{let s=window.getComputedStyle(i),r=i.getBoundingClientRect(),l=s.backgroundImage||"none",a="none";if(a&&a.includes("rgba")&&Color.fromRGBA(a).a===0&&(a="none"),l.includes("none")&&a.includes("none"))return!1;if((l||a)&&r.width>0&&r.height>0&&r.width>=o.width*.8&&r.height>=o.height*.8)return t=i,!0}),n||(n=[...e.querySelectorAll("img")].some(i=>{let s=i.getBoundingClientRect();return s.width>0&&s.height>0&&s.width>=o.width*.8&&s.height>=o.height*.8?(t=i,!0):!1}),n)?t:n}var c=window.xp??{},T=class{constructor({sectionType:e,sectionFeatures:n,template:t,confidence:i}){this.sectionType=e,this.sectionFeatures=n,this.template=t,this.confidence=i}},z=[{name:"header",predictFn:(o,e,n,t)=>!!(t.isFlagSet(h.isFromRootBox)&&e===0)},{name:"footer",predictFn:(o,e,n,t)=>!!(t.isFlagSet(h.isFromRootBox)&&e===n.length-1)},{name:"carousel",predictFn:(o,e,n,t)=>{let i=u.getNSiblingsElements(o.div,s=>s>=2);if(i){console.log("predict carousel"),console.log(i);let s={};i.forEach(l=>{let a=u.getXPath(l),d=[...l.querySelectorAll("div")].map(C=>u.getXPath(C).slice(a.length));console.log(d);let f=F(d.join(`
`));console.log(f),s[f]?s[f].push(l):s[f]=[l]});let r=Object.keys(s).filter(l=>s[l].length>1);if(s[r]){let l=!1,a=!1;if(s[r].forEach(d=>{u.isVisible(d)?l=!0:a=!0}),l&&a)return!0}return!1}return!1}},{name:"columns",predictFn:(o,e,n,t)=>t.isFlagSet(h.isGridLayout)},{name:"hero",predictFn:(o,e,n,t)=>o.height<=window.innerHeight&&t.isFlagSet(h.hasBackground)&&t.isFlagSet(h.hasHeading)&&t.isFlagSet(h.hasCallToAction)},{name:"heading",predictFn:(o,e,n,t)=>{if(!t.isFlagSet(h.hasHeading))return!1;let i=o.div.cloneNode(!0);i.querySelectorAll("script, style, link, meta, noscript").forEach(l=>l.remove()),console.groupCollapsed("heading");let s=k(i.querySelector("h1, h2, h3, h4, h5, h6")?.textContent),r=k(i.textContent);return console.log(s),console.log(r),console.groupEnd(),t.isFlagSet(h.hasTexts)&&s===r&&t.isFlagSet(h.hasHeading)&&!t.isFlagSet(h.hasImages)&&!t.isFlagSet(h.hasCallToAction)&&!t.isFlagSet(h.hasBackground)}},{name:"text",predictFn:(o,e,n,t)=>t.isFlagSet(h.hasTexts)&&!t.isFlagSet(h.hasImages)&&!t.isFlagSet(h.hasBackground)},{name:"text+icons",predictFn:(o,e,n,t)=>{let i=!0;[...o.div.querySelectorAll("img")].some(l=>{let a=l.getBoundingClientRect();return a.width>50&&a.height>50})&&(i=!1);let r=!o.children.some(l=>(console.log(l.prediction?.sectionType),!["heading","text","text+icons"].includes(l.prediction?.sectionType)));return console.log("childrenOnlyTextLike",r),!t.isFlagSet(h.isGridLayout)&&r&&t.isFlagSet(h.hasTexts)&&i&&!t.isFlagSet(h.hasBackground)}}];c.DOM=u;c.Flags=v;c.FlagSet=b;var V=[new g({name:"violet",r:148,g:0,b:211}),new g({name:"indigo",r:75,g:0,b:130}),new g({name:"blue",r:0,g:0,b:255}),new g({name:"green",r:0,g:255,b:0}),new g({name:"yellow",r:255,g:255,b:0}),new g({name:"orange",r:255,g:127,b:0}),new g({name:"red",r:255,g:0,b:0})];c.filterDivs=o=>{let e=o.filter(t=>{let i=t.getBoundingClientRect(),{width:s,height:r}=u.getPageSize();return!t.classList.contains("xp-ui")&&!t.closest(".xp-ui")&&i.width!==0&&i.height!==0&&i.width*i.height>1e4&&i.width*i.height<.8*s*r&&u.isVisible(t)});console.log(e.length),console.log(e.map(t=>t));let n=e.filter(t=>{let i=t.parentElement;for(;i;){let s=t.getBoundingClientRect(),r=i.getBoundingClientRect();if(r.width===0||r.height===0){i=i.parentElement;continue}if(s.width>=.9*r.width&&s.height>=.9*r.height)return!1;i=i.parentElement}return!0});return console.log(n.length),console.log(n.map(t=>t)),n};var j=O`position:absolute;left:${0}px;top:${1}px;width:${2}px;height:${3}px;border:2px solid ${4};`,q=(o,{target:e=document.body,padding:n=0,color:t=null,label:i=null})=>{let s=t||"rgba(0, 0, 255, 1)",r=u.getOffsetRect(o.div),l=document.createElement("div");if(l.dataset.boxId=o.id,l.className="xp-overlay",l.style=j(r.x+n,r.y+n,r.width-n*2-4,r.height-n*2-4,s),i){let a=document.createElement("div");a.className="xp-overlay-label",a.textContent=i,l.appendChild(a)}e.appendChild(l)};function A(o,e=0,n=V,t=null,i=0){o.children.forEach((s,r)=>{let l=t||n[r%(n.length-1)],a=i===0?1:Math.max(.1,.5-i*.1);q(s,{padding:e,color:l.withAlpha(a).toRGBA()}),s.children.length>0&&A(s,e+2,n,l,i+1)})}var h=new v("isFromRootBox","hasHeader","hasTexts","hasBackground","hasHeading","hasCallToAction","hasImages","hasMultipleColumns","hasMultipleRows","isGridLayout");function I(o,e,n,t=!0){if(o.ignored)return null;let i="unknown",s=new b,r=o.div;t&&s.setFlag(h.isFromRootBox);let l=r.cloneNode(!0);l.querySelectorAll("script, style, link, meta, noscript").forEach(x=>x.remove()),l.textContent.replaceAll(" ","").replaceAll(`
`,"").trim().length>0&&s.setFlag(h.hasTexts),([...r.querySelectorAll("img, picture, svg")].length>0||["IMG","PICTURE","SVG"].includes(r.nodeName))&&s.setFlag(h.hasImages),!!R(o)&&s.setFlag(h.hasBackground),([...r.querySelectorAll("h1, h2, h3, h4, h5, h6")].length>0||["H1","H2","H3","H4","H5","H6"].includes(r.nodeName))&&s.setFlag(h.hasHeading),[...r.querySelectorAll("a, button")].length>0&&s.setFlag(h.hasCallToAction);let S=o.determineLayout();S.numRows>1&&s.setFlag(h.hasMultipleRows),S.numCols>1&&s.setFlag(h.hasMultipleColumns),S.numCols>1&&m.areBoxesLaidOutAsGrid(o.children)&&s.setFlag(h.isGridLayout),o.children.forEach((...x)=>{I(...x,!1)});let H=z.find(x=>x.predictFn(o,e,n,s));return H?o.prediction=new T({sectionType:H.name,sectionFeatures:s,confidence:-1}):o.prediction=new T({sectionType:"unknown",sectionFeatures:s,confidence:-1}),console.log("prediction"),console.log(s.getFlags(h)),console.log("layout:",S),console.log(r),console.log("section prediction:",o.prediction),i}c.getAllVisibleDivs=()=>{let o=[...document.body.querySelectorAll("*")].filter(t=>!["IFRAME","NOSCRIPT","BR","EM","STRONG","STYLE","SCRIPT"].includes(t.nodeName)).reduce((t,i,s)=>{var r=i.closest("svg");return!(r!==null&&r!==i)&&!t.includes(i.nodeName)&&t.push(i.nodeName),t},[]);console.log("DOM node types:",o);let e=[...document.querySelectorAll(o.join(","))],n=c.filterDivs(e);return console.log(`found ${n.length} visible divs to show!`),n};c.buildBoxTree=o=>{let e=new m(0,0,window.innerWidth,window.document.scrollingElement.scrollHeight),n=o.map(m.fromDiv);function t(r,l,a){l.forEach((d,f)=>{if(a.has(f))return;if(r.contains(d,!1)){let B=d;r.addChild(B),a.add(f),t(B,l,a)}})}t(e,n,new Set);function i(r){r.determineLayout(),r.children.forEach(i)}i(e);function s(r){if(r.children.length===1&&r.layout.numCols===1){let l=r.children[0];r.children=l.children,s(r)}else r.children.forEach(s)}return s(e),e};c.getVerticalBoxesFromHierarchy=(o,e=!0)=>{let n={...o};function t(i){let s=i.children;if(s.some(l=>s.some(a=>l!==a&&!l.isInside(a)&&(l.x>=a.x+a.width||l.x+l.width<=a.x)))){i.setChildren([]);return}else for(let l=0;l<s.length;l++)t(s[l])}return t(n),n.children};c.boxes=null;c.highlightVerticalBoxes=()=>{let o=c.getAllVisibleDivs(),e=c.buildBoxTree(o),n=c.getVerticalBoxesFromHierarchy(e,!1),t=new m(0,0,window.innerWidth,window.document.scrollingElement.scrollHeight);t.setChildren(n),A(t)};c.analysePage=async()=>{c.ui?.resetOverlays(),await L();let o=c.getAllVisibleDivs();c.boxes=c.buildBoxTree(o),A(c.boxes),console.log(c.boxes),c.ui?.toggleOverlays(!0);let e=c.boxes.children.map(n=>u.getXPath(n.div)).join(`
`)||"";return c.boxes.template={raw:e,hash:F(e)},c.boxes.children.forEach((n,t,i)=>{I(n,t,i)}),c.boxes};c.predictPage=()=>{if(c.boxes?.children?.length>0){let e=function(t){t.ignored||(t.prediction&&t.prediction.sectionType!=="unknown"||t.prediction&&t.prediction.sectionType==="unknown"&&t.children.length===0?(o.push(t),console.warn(t.div,t.prediction),c.ui&&q(t,{padding:0,color:"rgba(0, 255, 0, 1)",label:t.prediction.sectionType})):t.children.forEach(e))};c.ui?.resetOverlays(),c.boxes.children.forEach((t,i,s)=>{I(t,i,s)});let o=[];e(c.boxes);let n=c.boxes.children.map(t=>{let i=[u.getXPath(t.div)];return i.push(...t.children.map(s=>"- "+u.getXPath(s.div))),i.join(`
`)||""}).join(`
`)||"";return console.log(c.boxes),c.boxes.template={raw:n,hash:F(n)},c.ui?.toggleOverlays(!0),c.boxes}};c.selectElementToIgnore=()=>{document.body.style.cursor="crosshair",c.ui.overlaysDiv().addEventListener("click",e=>{let n=e.target;n.classList.contains("xp-overlay")&&n.remove(),c.ignoreElementForDection(n.dataset.boxId),document.body.style.removeProperty("cursor")},{once:!0})};c.ignoreElementForDection=o=>{function e(n){if(n.id===o){let t=function(i){[...c.ui.overlaysDiv().querySelectorAll(".xp-overlay")].forEach(r=>{r.dataset.boxId===i.id&&r.remove()}),i.children.forEach(t)};return n.ignored=!0,t(n),!0}else return n.children.some(e)}e(c.boxes)};window.xp=c;})();
